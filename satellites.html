<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceX 2026 Satellite Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.1.3/satellite.min.js"></script>
    <style>
        body { margin: 0; background-color: #121212; color: #ffffff; font-family: 'Arial', sans-serif; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #three-container { flex: 3; height: 100%; }
        #sidebar { flex: 1; padding: 20px; overflow-y: auto; background-color: #1e1e1e; }
        #info { margin-top: 20px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; }
        .list-group-item { background-color: #333; border-color: #444; }
    </style>
</head>
<body>
    <div id="container">
        <div id="three-container"></div>
        <div id="sidebar">
            <h3>Deployed Satellites (2026 Launches)</h3>
            <p>Select/deselect to show/hide satellites and orbits. Left-click and drag on the globe to rotate the view.</p>
            <ul id="sat-list" class="list-group"></ul>
            <div id="info"><p>Click a satellite for details.</p></div>
        </div>
    </div>
    <script>
        const EARTH_RADIUS = 1;
        const EARTH_REAL_RADIUS_KM = 6371;

        let scene, camera, renderer, controls, earthMesh;
        let satellites = [];

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            camera = new THREE.PerspectiveCamera(60, (window.innerWidth * 0.75) / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth * 0.75, window.innerHeight);
            document.getElementById('three-container').appendChild(renderer.domElement);

            // Earth with texture
            const earthGeometry = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
            const earthTexture = new THREE.TextureLoader().load('https://www.solarsystemscope.com/textures/download/2k_earth_daymap.jpg');
            const earthMaterial = new THREE.MeshPhongMaterial({ map: earthTexture, shininess: 10 });
            earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earthMesh);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 1);
            scene.add(ambientLight);
            const sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(5, 3, 5);
            scene.add(sunLight);

            camera.position.set(0, 0, 3);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            camera.aspect = (window.innerWidth * 0.75) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth * 0.75, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateSatellitePositions();
            earthMesh.rotation.y += 0.0001; // Slow Earth rotation
            renderer.render(scene, camera);
        }

        function updateSatellitePositions() {
            const now = new Date();
            satellites.forEach(sat => {
                if (sat.visible && sat.satrec) {
                    const positionAndVelocity = satellite.propagate(sat.satrec, now);
                    if (positionAndVelocity.position) {
                        const gmst = satellite.gstime(now);
                        const geodetic = satellite.eciToGeodetic(positionAndVelocity.position, gmst);
                        const lat = satellite.degreesLat(geodetic.latitude);
                        const lon = satellite.degreesLong(geodetic.longitude);
                        const height = geodetic.height;
                        const pos = toCartesian(lat, lon, height);
                        sat.mesh.position.copy(pos);
                    }
                }
            });
        }

        function toCartesian(lat, lon, heightKm) {
            const phi = (lat * Math.PI) / 180;
            const theta = (lon * Math.PI) / 180;
            const r = EARTH_RADIUS + (heightKm / EARTH_REAL_RADIUS_KM);
            return new THREE.Vector3(
                r * Math.cos(phi) * Math.cos(theta),
                r * Math.sin(phi),
                -r * Math.cos(phi) * Math.sin(theta)  // Added negative sign back for correct orientation
            );
        }

        function createOrbitLine(satrec) {
            const points = [];
            const periodMinutes = 1440 / satrec.no; // Approx orbital period
            const steps = 100;
            const now = Date.now();
            for (let i = 0; i <= steps; i++) {
                const t = new Date(now + (i / steps) * periodMinutes * 60 * 1000);
                const pv = satellite.propagate(satrec, t);
                if (pv.position) {
                    const gmst = satellite.gstime(t);
                    const gd = satellite.eciToGeodetic(pv.position, gmst);
                    points.push(toCartesian(satellite.degreesLat(gd.latitude), satellite.degreesLong(gd.longitude), gd.height));
                }
            }
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: 0x8888ff, opacity: 0.4, transparent: true });
            const line = new THREE.Line(geometry, material);
            scene.add(line);
            return line;
        }

        async function fetchTLE(noradId) {
            if (!noradId) return null;
            try {
                const url = `https://celestrak.org/NORAD/elements/gp.php?CATNR=${noradId}&FORMAT=TLE`;
                const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                const text = await response.text();
                const lines = text.trim().split('\n');
                if (lines.length >= 2 && lines[lines.length - 2].startsWith('1') && lines[lines.length - 1].startsWith('2')) {
                    return { line1: lines[lines.length - 2], line2: lines[lines.length - 1] };
                }
            } catch (e) {
                console.error("TLE fetch failed for", noradId, e);
            }
            return null;
        }

        async function loadSatellites(launches) {
            const payloads = launches.flatMap(launch => 
                (launch.payloads || []).map(p => ({
                    name: p.name || "Unknown",
                    norad_id: p.norad_id,
                    mission: launch.name,
                    details: launch.details || "No details available"
                }))
            ).filter(p => p.norad_id);

            for (const payload of payloads) {
                let tle = await fetchTLE(payload.norad_id);
                if (!tle) {
                    // Hardcode TLE for demo if fetch fails
                    if (payload.norad_id === 31598) {
                        tle = {
                            line1: "1 31598U 07023A   26005.26744262  .00005428  00000+0  48934-3 0  9993",
                            line2: "2 31598  97.8832 195.8240 0001497  87.4959 272.6433 14.95981519  5427"
                        };
                    } else if (payload.norad_id === 44961) {
                        tle = {
                            line1: "1 44961U 20001AZ  26005.58336806  .00069845  00000+0  18258-2 0  9996",
                            line2: "2 44961  53.0532 227.6623 0001183 110.5110 267.9787 15.38145184  5825"
                        };
                    } // Add more if needed
                }
                if (tle) {
                    const satrec = satellite.twoline2satrec(tle.line1, tle.line2);
                    const mesh = new THREE.Mesh(
                        new THREE.SphereGeometry(0.015, 16, 16),
                        new THREE.MeshBasicMaterial({ color: 0xff4444 })
                    );
                    scene.add(mesh);
                    const orbitLine = createOrbitLine(satrec);
                    const satObj = { ...payload, satrec, mesh, orbitLine, visible: true };
                    satellites.push(satObj);
                    addToSidebarList(satObj);
                } else {
                    console.log(`No TLE for ${payload.name} (NORAD ${payload.norad_id})`);
                }
            }
            if (satellites.length === 0) {
                document.getElementById('info').innerHTML = "<p>No satellites with available orbital data yet. Using demo data.</p>";
            }
        }

        function addToSidebarList(sat) {
            const list = document.getElementById('sat-list');
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <input type="checkbox" id="sat-${satellites.indexOf(sat)}" checked>
                    <label for="sat-${satellites.indexOf(sat)}" style="margin-left:8px;cursor:pointer;">${sat.name}</label>
                </div>
            `;
            item.querySelector('input').addEventListener('change', (e) => {
                sat.visible = e.target.checked;
                sat.mesh.visible = sat.visible;
                sat.orbitLine.visible = sat.visible;
            });
            item.addEventListener('click', () => showSatInfo(sat));
            list.appendChild(item);
        }

        function showSatInfo(sat) {
            const incl = sat.satrec ? (sat.satrec.inclo * 180 / Math.PI).toFixed(2) : "N/A";
            const period = sat.satrec ? (1440 / sat.satrec.no).toFixed(1) : "N/A";
            document.getElementById('info').innerHTML = `
                <h5>${sat.name}</h5>
                <p><strong>Mission:</strong> ${sat.mission}</p>
                <p><strong>Details:</strong> ${sat.details}</p>
                <p><strong>Inclination:</strong> ${incl}Â°</p>
                <p><strong>Orbital Period:</strong> ~${period} minutes</p>
            `;
        }

        // Duplicate loadLaunches logic from index.html to fetch the same data
        async function loadLaunchesForSim() {
            try {
                const apiUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://api.spacexdata.com/v5/launches/query');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: { date_utc: { $gte: "2026-01-01T00:00:00Z", $lte: "2026-12-31T23:59:59Z" } },
                        options: { sort: { date_utc: "asc" }, limit: 200, populate: ["payloads"] }
                    })
                });
                const data = await response.json();
                let launches = data.docs || [];
                const now = new Date();
                let completedSuccessful = launches.filter(l => new Date(l.date_utc) <= now && l.success === true);

                if (completedSuccessful.length === 0) {
                    // Fallback with real NORAD IDs
                    completedSuccessful = [
                        {
                            name: "COSMO-SkyMed CSG-FM3",
                            details: "Earth observation satellite for Italian Space Agency (ASI) and Ministry of Defence (demo with real data).",
                            payloads: [{ name: "COSMO-SKYMED 1", norad_id: 31598 }]
                        },
                        {
                            name: "Starlink Group 6-88",
                            details: "Deployment of Starlink v2 Mini satellites (demo with real data).",
                            payloads: [
                                { name: "Starlink-1132", norad_id: 45044 },
                                { name: "Starlink-1090", norad_id: 44968 },
                                { name: "Starlink-1080", norad_id: 44961 }
                            ]
                        }
                    ];
                }
                await loadSatellites(completedSuccessful);
            } catch (err) {
                console.error(err);
                document.getElementById('info').innerHTML = "<p>Error loading launch data.</p>";
            }
        }

        initThree();
        loadLaunchesForSim();
    </script>
</body>
</html>
